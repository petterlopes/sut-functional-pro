# üîí SUT System - Security Hardening Guide































































































































## Vis√£o Geral































































































































Este documento descreve as implementa√ß√µes de seguran√ßa implementadas no sistema SUT, incluindo hardening do Keycloak, autentica√ß√£o JWT robusta, e configura√ß√µes de seguran√ßa para frontend e backend.































































































































## üõ°Ô∏è Implementa√ß√µes de Seguran√ßa































































































































### 1. **Keycloak Hardening**































































































































#### Configura√ß√µes de Realm Seguras































































- ‚úÖ **SSL Required**: For√ßa HTTPS em produ√ß√£o































































- ‚úÖ **Brute Force Protection**: Prote√ß√£o contra ataques de for√ßa bruta































































- ‚úÖ **Password Policy**: Pol√≠tica de senhas robusta (12+ caracteres, mai√∫sculas, min√∫sculas, n√∫meros, s√≠mbolos)































































- ‚úÖ **Session Management**: Timeouts de sess√£o configurados































































- ‚úÖ **Token Lifespan**: Tempos de vida de tokens otimizados































































- ‚úÖ **PKCE**: Proof Key for Code Exchange habilitado































































- ‚úÖ **MFA Ready**: Configura√ß√£o para autentica√ß√£o multifator































































































































#### Configura√ß√µes de Cliente































































```json































































{































































  "clientId": "sut-frontend",































































  "publicClient": true,































































  "standardFlowEnabled": true,































































  "implicitFlowEnabled": false,































































  "directAccessGrantsEnabled": false,































































  "attributes": {































































    "pkce.code.challenge.method": "S256",































































    "access.token.lifespan": "900",































































    "client.session.idle.timeout": "1800"































































  }































































}































































```































































































































#### Pol√≠tica de Senhas































































```































































length(12) and digits(2) and lowerCase(2) and upperCase(2) and specialChars(2) and notUsername































> As contas seed (`admin`, `manager`, `analyst`) s?o criadas com `temporary=true`. O primeiro login for?a troca de senha; remova-as ou rotacione-as antes de liberar o ambiente.































































```































































































































### 2. **JWT Security Configuration**



- `DEV_AUTH_BYPASS` s? pode ser usado em ambientes com `RUST_ENV` diferente de `production` e exige cabe?alho `X-Dev-User`.





























































































































#### Valida√ß√µes Implementadas































































- ‚úÖ **Algorithm Validation**: Apenas algoritmos seguros (RS256, RS384, RS512)































































- ‚úÖ **Token Expiration**: Valida√ß√£o de expira√ß√£o com clock skew































































- ‚úÖ **Audience Validation**: Verifica√ß√£o de audience































































- ‚úÖ **Issuer Validation**: Verifica√ß√£o de issuer































































- ‚úÖ **Token Blacklist**: Sistema de blacklist para tokens revogados































































- ‚úÖ **Role-based Access**: Middleware para verifica√ß√£o de roles































































































































#### Estrutura de Claims































































```rust































































pub struct JwtClaims {































































    pub iss: String,           // Issuer































































    pub sub: String,           // Subject (user ID)































































    pub aud: Vec<String>,      // Audience































































    pub exp: u64,              // Expiration time































































    pub iat: u64,              // Issued at































































    pub jti: Option<String>,   // JWT ID































































    pub realm_access: Option<RealmAccess>,































































    pub email: Option<String>,































































    // ... outros campos































































}































































```































































































































### 3. **Security Headers**































































































































#### Headers Implementados































































```rust































































// Headers de seguran√ßa configur√°veis































































Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; ...































































X-Frame-Options: DENY































































X-Content-Type-Options: nosniff































































X-XSS-Protection: 1; mode=block































































Referrer-Policy: strict-origin-when-cross-origin































































Strict-Transport-Security: max-age=31536000; includeSubDomains; preload































































Permissions-Policy: camera=(), microphone=(), geolocation=(), ...































































Cross-Origin-Embedder-Policy: require-corp































































Cross-Origin-Opener-Policy: same-origin































































Cross-Origin-Resource-Policy: same-origin































































```































































































































### 4. **Database Security**































































































































#### PostgreSQL Hardening































































- ‚úÖ **SSL/TLS**: Conex√µes criptografadas































































- ‚úÖ **SCRAM-SHA-256**: Autentica√ß√£o segura































































- ‚úÖ **Connection Limits**: Limites de conex√£o































































- ‚úÖ **Audit Logging**: Log de todas as opera√ß√µes































































- ‚úÖ **Access Control**: Controle de acesso por IP































































































































#### Configura√ß√µes de Seguran√ßa































































```sql































































-- Autentica√ß√£o segura































































password_encryption = scram-sha-256































































































































-- SSL obrigat√≥rio































































ssl = on































































ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'































































ssl_min_protocol_version = 'TLSv1.2'































































































































-- Logging de seguran√ßa































































log_connections = on































































log_disconnections = on































































log_statement = 'mod'































































```































































































































### 5. **Frontend Security**































































































































#### Keycloak Integration































































- ‚úÖ **PKCE Flow**: Authorization Code Flow com PKCE































































- ‚úÖ **Token Refresh**: Renova√ß√£o autom√°tica de tokens































































- ‚úÖ **Role Management**: Gerenciamento de roles no frontend































































- ‚úÖ **Secure Storage**: Armazenamento seguro de tokens































































- ‚úÖ **CORS Configuration**: Configura√ß√£o CORS adequada































































































































#### API Client Security







- Webhooks exigem `X-Webhook-Token` com o valor de `WEBHOOK_SHARED_SECRET`; configure armazenando o segredo fora do reposit?rio.



























































```typescript































































// Headers de seguran√ßa autom√°ticos































































headers: {































































  'Authorization': `Bearer ${token}`,































































  'X-Requested-With': 'XMLHttpRequest',































































  'X-Client-Version': '1.0.0',































































  'Content-Type': 'application/json'































































}































































```































































































































### 6. **Role-Based Access Control (RBAC)**































































































































#### Roles Implementadas































































- **admin**: Acesso total ao sistema































































- **user**: Usu√°rio padr√£o































































- **directory.read**: Leitura de dados do diret√≥rio































































- **directory.write**: Escrita de dados do diret√≥rio































































- **directory.merge**: Merge de dados do diret√≥rio































































- **directory.pii.read**: Acesso a dados PII































































- **audit.read**: Leitura de logs de auditoria































































































































#### Middleware de Autoriza√ß√£o































































```rust































































// Middleware para verificar roles espec√≠ficas































































pub async fn require_role_middleware(































































    required_roles: Vec<String>,































































    request: Request,































































    next: Next,































































) -> Result<Response, StatusCode>































































































































// Middlewares espec√≠ficos































































pub async fn require_admin_middleware(...)































































pub async fn require_read_permission_middleware(...)































































pub async fn require_write_permission_middleware(...)































































```































































































































## üîß Configura√ß√£o de Desenvolvimento































































































































### 1. **Vari√°veis de Ambiente**































































































































#### Backend (.env)































































```bash































































# Keycloak Configuration































































KEYCLOAK_ISSUER=http://localhost:8081/realms/sut































































KEYCLOAK_JWKS=http://localhost:8081/realms/sut/protocol/openid-connect/certs































































KEYCLOAK_AUDIENCE=sut-frontend,account































































































































# Database































































PG_DSN=postgres://sut:Sut@Postgres2024!@localhost:5432/sut































































































































# Security































































CORS_ALLOWED_ORIGINS=http://localhost:5173































































METRICS_TOKEN=dev-metrics-token































































WEBHOOK_SHARED_SECRET=dev-shared-webhook-token































































DEV_AUTH_BYPASS=0































































RUST_LOG=info































































```































































































































#### Frontend (.env.local)































































```bash































































# Keycloak































































VITE_KC_URL=http://localhost:8081































































VITE_KC_REALM=sut































































VITE_KC_CLIENT=sut-frontend































































































































# API































































VITE_API_BASE=http://localhost:8080































































































































# Security































































VITE_DEV_MODE=true































































```































































































































### 2. **Usu√°rios de Desenvolvimento**















> **Nota**: os usu?rios de demonstra??o do Keycloak t?m senhas tempor?rias e os seeds SQL s? executam quando `app.enable_demo_users` estiver habilitado. Nunca habilite esse flag em produ??o.































































































































#### Admin User































































- **Username**: admin































































- **Password**: Admin@SUT2024!































































- **Roles**: admin, directory.read, directory.write, directory.merge, directory.pii.read, audit.read































































































































#### Standard User































































- **Username**: user































































- **Password**: User@SUT2024!































































- **Roles**: user, directory.read































































































































#### Developer User































































- **Username**: dev































































- **Password**: Dev@SUT2024!































































- **Roles**: user, directory.read, directory.write, directory.merge, directory.pii.read































































































































## üöÄ Deploy em Produ√ß√£o































































































































### 1. **Configura√ß√µes de Produ√ß√£o**































































































































#### Keycloak































































- ‚úÖ Usar HTTPS































































- ‚úÖ Configurar dom√≠nio real































































- ‚úÖ Desabilitar registros p√∫blicos































































- ‚úÖ Configurar MFA































































- ‚úÖ Implementar backup de chaves































































































































#### Database































































- ‚úÖ Usar senhas fortes































































- ‚úÖ Configurar SSL/TLS































































- ‚úÖ Implementar backup































































- ‚úÖ Configurar monitoramento































































































































#### Application
- Configure `METRICS_TOKEN`, `WEBHOOK_SHARED_SECRET` e `CORS_ALLOWED_ORIGINS` antes de iniciar a API; o boot falha em produ??o se estiverem vazios.































































- ‚úÖ Usar HTTPS































































- ‚úÖ Configurar CORS adequadamente































































- ‚úÖ Implementar rate limiting































































- ‚úÖ Configurar logging de auditoria































































































































### 2. **Checklist de Seguran√ßa**































































































































- [ ] SSL/TLS configurado em todos os servi√ßos































































- [ ] Senhas fortes em produ√ß√£o































































- [ ] CORS configurado adequadamente































































- [ ] Rate limiting implementado































































- [ ] Logging de auditoria ativo































































- [ ] Backup de chaves JWT































































- [ ] Monitoramento de seguran√ßa































































- [ ] Testes de penetra√ß√£o realizados































































































































## üìä Monitoramento de Seguran√ßa































































































































### 1. **M√©tricas de Seguran√ßa**































































- Tentativas de login falhadas































































- Tokens expirados































































- Acessos negados por falta de permiss√£o































































- Tentativas de acesso a recursos protegidos































































































































### 2. **Alertas de Seguran√ßa**































































- M√∫ltiplas tentativas de login falhadas































































- Acesso a recursos sens√≠veis































































- Tokens suspeitos































































- Anomalias de tr√°fego































































































































## üîç Testes de Seguran√ßa































































































































### 1. **Testes Automatizados**































































- Valida√ß√£o de JWT































































- Verifica√ß√£o de headers de seguran√ßa































































- Testes de autoriza√ß√£o































































- Valida√ß√£o de CORS































































































































### 2. **Testes Manuais**































































- Testes de penetra√ß√£o































































- Verifica√ß√£o de vulnerabilidades































































- Testes de for√ßa bruta































































- Valida√ß√£o de configura√ß√µes































































































































## üìö Refer√™ncias































































































































- [OWASP Security Guidelines](https://owasp.org/)































































- [Keycloak Security Best Practices](https://www.keycloak.org/docs/latest/securing_apps/)































































- [JWT Security Best Practices](https://tools.ietf.org/html/rfc8725)































































- [PostgreSQL Security](https://www.postgresql.org/docs/current/security.html)































































































































## üÜò Suporte































































































































Para quest√µes de seguran√ßa, entre em contato com a equipe de seguran√ßa:































































- Email: security@sut.local































































- Slack: #security-team































































- Urg√™ncia: +55 11 99999-9999































































































































---































































































































**‚ö†Ô∏è IMPORTANTE**: Este documento cont√©m informa√ß√µes sens√≠veis de seguran√ßa. Mantenha-o confidencial e atualize-o regularmente.































































